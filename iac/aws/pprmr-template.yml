# Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
AWSTemplateFormatVersion: "2010-09-09"
Description: CF configurations for PDF Permission Remover AWS Components.

Metadata:
  "AWS::CloudFormation::Interface":
    ParameterGroups:
      - Label:
          default: Required Tags
        Parameters:
          - Blockcode
          - CostCenter
          - UniqueID
          - DataClassification
          - SupportGroup
          - ChangeGroup
          - DrTier
          - PciIndicator
          - PhiIndicator
          - SoxIndicator
          - CuiIndicator
      - Label:
          default: Application Configurations
        Parameters:
          - AppPrefix
          - GroupResourcePrefix
          - Environment
      - Label:
          default: Policies and Roles
        Parameters:
          - LambdaPolicyName
          - LambdaRoleName
          - ApiPolicyName
          - ApiRoleName

      - Label:
          default: S3 Configurations
        Parameters:
          - UploadFilesBucketName
          - ConvertedFilesBucketName
          - S3LogsBucketName

      - Label:
          default: API Gateway Configurationss
        Parameters:
          - APIRestApiName
          - APICustomUri
          - APIEndpointType
          - Route53HostedZone
          - CertificateAuthorityArnValue
      - Label:
          default: Lambda Function Configurations
        Parameters:
          - PprmrLambdaCodeBucket
          - PprmrLambdaCodeKey
          - PprmrLambdaFunctionName
          - PprmrPresignedLambdaFunctionName

Parameters:
  # Prompt for Blockcode
  Blockcode:
    Type: String
    Description: Enter the block code for the Application
    AllowedPattern: ^[A-Z]{10}$
    Default: TOPEGDRPPO

  # Prompt for CostCenter
  CostCenter:
    Type: String
    Description: Enter the cost center for the Application
    AllowedPattern: ^C[0-9]{4}ATG$
    Default: C8730ATG

  # Prompt for UniqueID
  UniqueID:
    Type: String
    Description: Enter the unique id for the Application
    AllowedPattern: ^(D|A)[0-9]{7}$
    Default: D0021372

  # Prompt for DataClassification
  DataClassification:
    Type: String
    Description: Enter the data classification for the Application
    AllowedValues:
      - public
      - internal
      - confidential
      - restricted
    Default: confidential

  # Prompt for cuiIndicator
  CuiIndicator:
    Type: String
    Description: Refers to the category of unclassified information within the U.S. Federal government. Confidential.
    AllowedValues: [true, false]
    Default: false

  # Prompt for pciIndicator
  PciIndicator:
    Type: String
    Description: Refers to the category used for credit cardholder data and sensitive authentication data.
    AllowedValues: [true, false]
    Default: false

  # Prompt for phiIndicator
  PhiIndicator:
    Type: String
    Description: Refers to any health information (medical and insurance) related to an individual.
    AllowedValues: [true, false]
    Default: false

  # Prompt for soxIndicator
  SoxIndicator:
    Type: String
    Description: Refers to any information that has a direct and material impact on Delta's financial reporting.
    AllowedValues: [true, false]
    Default: false

  # Prompt for DrTier
  DrTier:
    Type: String
    Description: A tier designation, which defines the chronological order of recovery for an application during an IT Disaster event
    AllowedValues:
      - mission vital
      - mission critical
      - business critical
      - business essential
      - business
    Default: business essential

  # Prompt for SupportGroup
  SupportGroup:
    Type: String
    Description: Enter the support group for the Application
    AllowedPattern: ^[A-Za-z0-9_ -]+$
    Default: DN - MEMDS2

  # Prompt for ChangeGroup
  ChangeGroup:
    Type: String
    Description: Enter the change group for the Application
    AllowedPattern: ^[A-Za-z0-9_ -]+$
    Default: DN - MEMDS2

  GroupResourcePrefix:
    Type: String
    Default: "techops-eng"
    Description: "Prefix to use in naming resources to be created by this template"

  AppPrefix:
    Type: String
    Default: "pprmr"
    Description: "App Prefix to use in naming resources to be created by this template"

  Environment:
    Description: Environment to deploy.
    Type: String
    Default: dev2
    AllowedValues: ["dev2", "dev", "si", "prod"]
    ConstraintDescription: Must specify dev, si or prod.

  ##S3 Buckets
  UploadFilesBucketName:
    Type: String
    Default: "techops-eng-dev2-pprmr-uploaded-files-s3"
    Description: "S3 bucket to host uploaded PDF files"
    AllowedPattern: ^techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]s3$
    ConstraintDescription: Bucket names must be lowercase, start and end with a letter or number, and be between 3 and 63 characters in length.

  ConvertedFilesBucketName:
    Type: String
    Default: "techops-eng-dev2-pprmr-converted-files-s3"
    Description: "S3 bucket to host processed PDF files"
    AllowedPattern: ^techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]s3$
    ConstraintDescription: Bucket names must be lowercase, start and end with a letter or number, and be between 3 and 63 characters in length.

  S3LogsBucketName:
    Type: String
    Default: "techops-eng-dev2-pprmr-logs-s3"
    Description: "S3 bucket to host S3 logs"
    AllowedPattern: ^techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]s3$
    ConstraintDescription: Bucket names must be lowercase, start and end with a letter or number, and be between 3 and 63 characters in length.

  PprmrLambdaCodeBucket:
    Type: String
    Default: "techops-eng-dev2-pprmr-lambda-code-s3"
    Description: "S3 bucket that contains lambda function java project"
    AllowedPattern: ^techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]s3$
    ConstraintDescription: Bucket names must be lowercase, start and end with a letter or number, and be between 3 and 63 characters in length.

  PprmrLambdaCodeKey:
    Type: String
    Default: "pdf-password-remover-lambda.jar"
    Description: "S3 bucket file that contains lambda function java project"

  APIRestApiName:
    Type: String
    Default: "techops-eng-dev2-pprmr-api"
    Description: "PDF Pwd Remover API Gateway Name"
    AllowedPattern: ^techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]api$
    ConstraintDescription: Bucket names must be lowercase, start and end with a letter or number, and be between 3 and 63 characters in length.

  APICustomUri:
    Type: String
    Description: "The name of the stage to deploy the API to."
    Default: "pdfpwdrmr-api.techops-dev.aws.delta.com"

  Route53HostedZone:
    Type: String
    Description: The name of the Route53HostedZone created in the AWS account
    Default: techops-dev.aws.delta.com.

  APIEndpointType:
    Type: String
    Description: "The name of the EndpointType for the custom domain values are Regional,Edge"
    Default: "REGIONAL"
    AllowedValues:
      - REGIONAL
      - PRIVATE

  CertificateAuthorityArnValue:
    # Type : 'AWS::SSM::Parameter::Value<String>'
    Type: String
    Description: "Certificate Authority Arn"
    # Default: /delta/acm/pca/arn
    Default: "arn:aws:acm-pca:us-east-1:945041172800:certificate-authority/4d67b2ea-f6d6-410f-ac45-7466e2fb8351"

    # PrefixDomainName:
    #   Type: String
    #   Default: "pdfpwdrmr-api"
    #   Description: "Hosted zone for Domain Name"

    # CertificateAuthority:
    #   Type: List<AWS::ACMPCA::CertificateAuthority::Id>
    #   Description: "Certificate Authority for Custom Domain Name"

  LambdaRoleName:
    Type: String
    Description: Enter the Lambda role name
    Default: delegate-admin-techops-eng-dev2-pprmr-lambda-access-role
    AllowedPattern: ^delegate-admin-techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]role$
    MaxLength: 64

  ApiRoleName:
    Type: String
    Description: Enter the API Gateway role name
    Default: delegate-admin-techops-eng-dev2-pprmr-api-gateway-access-role
    AllowedPattern: ^delegate-admin-techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]role$
    MaxLength: 64

  LambdaPolicyName:
    Type: String
    Description: Enter the Lambda Policy name
    Default: delegate-admin-techops-eng-dev2-pprmr-lambda-policy
    AllowedPattern: ^delegate-admin-techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]policy$
    MaxLength: 64

  ApiPolicyName:
    Type: String
    Description: Enter the API Gateway Policy name
    Default: delegate-admin-techops-eng-dev2-pprmr-api-policy
    AllowedPattern: ^delegate-admin-techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]policy$
    MaxLength: 64

  PprmrLambdaFunctionName:
    Type: String
    Description: Enter the Lambda function name
    Default: techops-eng-dev2-pprmr-lambda
    AllowedPattern: ^techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]lambda$
    MaxLength: 64

  PprmrPresignedLambdaFunctionName:
    Type: String
    Description: Enter the Presigned Lambda function name
    Default: techops-eng-dev2-pprmr-prsgn-url-lambda
    AllowedPattern: ^techops-eng[-](dev2|dev|si|prd)[-](.*?)[-]lambda$
    MaxLength: 64

Resources:
  #####S3 Buckets#####
  #S3 Bucket for Upload Files
  UploadBucket:
    Type: AWS::S3::Bucket
    DependsOn: "S3InvokeLambdaPermission"
    Properties:
      BucketName: !Ref UploadFilesBucketName
      NotificationConfiguration:
        LambdaConfigurations:
          - Function: !GetAtt PprmrLambdaFunction.Arn
            Event: "s3:ObjectCreated:Put"
            Filter:
              S3Key:
                Rules:
                  - Name: suffix
                    Value: .pdf
      #TODO Uncomment
      # LoggingConfiguration:
      #   DestinationBucketName: !Ref S3LogsBucket
      #   LogFilePrefix: pprmr-s3-logs/uploaded-files-logs/
      LifecycleConfiguration:
        Rules:
          - Id: delete-expired-uploaded-files
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpirationInDays: 1
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - "*"
            AllowedMethods:
              - POST
              - GET
              - PUT
              - HEAD
            AllowedHeaders:
              - "*"
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  #S3 Bucket for Processed Files
  ConvertedBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref ConvertedFilesBucketName
      #TODO Uncomment
      # LoggingConfiguration:
      #   DestinationBucketName: !Ref S3LogsBucket
      #   LogFilePrefix: pprmr-s3-logs/converted-files-logs/
      LifecycleConfiguration:
        Rules:
          - Id: delete-expired-error-files
            Prefix: error-files/
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpirationInDays: 1
          - Id: delete-expired-success-files
            Prefix: success-files/
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpirationInDays: 1
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - "*"
            AllowedMethods:
              - POST
              - GET
              - PUT
              - HEAD
            AllowedHeaders:
              - "*"
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  #S3 Bucket for Logs
  S3LogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref S3LogsBucketName
      AccessControl: "LogDeliveryWrite"
      LifecycleConfiguration:
        Rules:
          - Id: delete-old-logs
            Prefix: pprmr-s3-logs/
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpirationInDays: 1
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  ##### Policies #####
  ApiGatewayAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Ref ApiPolicyName
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - s3:PutObject
              - s3:GetObject
              - s3:ListBucketVersions
              - s3:ListBucket
              - s3:PutObjectTagging
              - s3:DeleteObject
            Effect: Allow
            Resource:
              - Fn::Sub: arn:aws:s3:::${UploadFilesBucketName}
              - Fn::Sub: arn:aws:s3:::${UploadFilesBucketName}/*
              - Fn::Sub: arn:aws:s3:::${ConvertedFilesBucketName}
              - Fn::Sub: arn:aws:s3:::${ConvertedFilesBucketName}/*
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - "*"
          - Action:
              - s3:ListAllMyBuckets
            Effect: Allow
            Resource:
              - Fn::Sub: arn:aws:s3:::${UploadFilesBucketName}
              - Fn::Sub: arn:aws:s3:::${UploadFilesBucketName}}/*
              - Fn::Sub: arn:aws:s3:::${ConvertedFilesBucketName}
              - Fn::Sub: arn:aws:s3:::${ConvertedFilesBucketName}/*

  LambdaAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Ref LambdaPolicyName
      Description: Techops Eng Pdf Pw Remover Policy for S3 and Cloudwatch
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - s3:PutObject
              - s3:GetObject
              - s3:ListBucketVersions
              - s3:ListBucket
              - s3:PutObjectTagging
              - s3:DeleteObject
            Effect: Allow
            Resource:
              - Fn::Sub: arn:aws:s3:::${UploadFilesBucketName}
              - Fn::Sub: arn:aws:s3:::${UploadFilesBucketName}/*
              - Fn::Sub: arn:aws:s3:::${ConvertedFilesBucketName}
              - Fn::Sub: arn:aws:s3:::${ConvertedFilesBucketName}/*
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
              - s3:ListAllMyBuckets
            Effect: Allow
            Resource:
              - "*"

  S3InvokeLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt PprmrLambdaFunction.Arn
      Principal: s3.amazonaws.com
      SourceAccount: !Ref "AWS::AccountId"
      SourceArn: !Sub "arn:aws:s3:::${UploadFilesBucketName}"

  ApiGatewayInvokeLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt PprmrPresgnUrlFunction.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${PprmrApiGateway}/*/GET/s3/*/*

  #### Roles #####
  PprmrLambdaFunctionRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Ref LambdaRoleName
      PermissionsBoundary: !Sub arn:aws:iam::${AWS::AccountId}:policy/cft-developer-boundary-policy
      Path: "/"
      ManagedPolicyArns:
        - !Ref LambdaAccessPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - #Sid: "AllowLambdaServiceToAssumeRole"
            Effect: "Allow"
            Action:
              - "sts:AssumeRole"
            Principal:
              Service:
                - "lambda.amazonaws.com"
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  PprmrApiGatewayRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Ref ApiRoleName
      PermissionsBoundary: !Sub arn:aws:iam::${AWS::AccountId}:policy/cft-developer-boundary-policy
      Path: "/"
      ManagedPolicyArns:
        - !Ref ApiGatewayAccessPolicy
        - "arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - #Sid: "AllowApiGatewayToAssumeRole"
            Effect: "Allow"
            Action:
              - "sts:AssumeRole"
            Principal:
              Service:
                - "apigateway.amazonaws.com"
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  #### Lambda Functions ####
  PprmrLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref PprmrLambdaFunctionName
      Description: Lambda function that will remove permission from uploaded PDF files from S3 bucket
      Handler: com.delta.techops.eng.pprmr.PdfPwRemoverUploadHandler::handleRequest
      Runtime: java8
      Role: !GetAtt PprmrLambdaFunctionRole.Arn
      Timeout: 300
      MemorySize: 4096
      Code:
        S3Bucket: !Ref PprmrLambdaCodeBucket
        S3Key: !Ref PprmrLambdaCodeKey
      Environment:
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  PprmrPresgnUrlFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref PprmrPresignedLambdaFunctionName
      Description: Lambda function that will return presigned URL for S3 connection
      Handler: com.delta.techops.eng.pprmr.PdfPwRemoverPresignedUrlHandler::handleRequest
      Runtime: java8
      Role: !GetAtt PprmrLambdaFunctionRole.Arn
      Timeout: 300
      MemorySize: 512
      Code:
        S3Bucket: !Ref PprmrLambdaCodeBucket
        S3Key: !Ref PprmrLambdaCodeKey
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  #### API Gateway ####
  PprmrApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Description: Techops PDF PW Remover API Gateway
      Name: !Ref APIRestApiName
      EndpointConfiguration:
        Types:
          - !Ref APIEndpointType
      Parameters:
        endpointConfigurationTypes: REGIONAL
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  PprmrApiGatewayBucketResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt PprmrApiGateway.RootResourceId
      PathPart: "{bucket}"
      RestApiId: !Ref PprmrApiGateway

  PprmrApiGatewayPresignedResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt PprmrApiGateway.RootResourceId
      PathPart: "s3"
      RestApiId: !Ref PprmrApiGateway

  PprmrApiGatewayPresignedBucketResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref PprmrApiGatewayPresignedResource
      PathPart: "{bucket}"
      RestApiId: !Ref PprmrApiGateway

  PprmrApiGatewayPresignedBucketKeyResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref PprmrApiGatewayPresignedBucketResource
      PathPart: "{key}"
      RestApiId: !Ref PprmrApiGateway

  # ApiGatewayStage:
  #   Type: AWS::ApiGateway::Stage
  #   Properties:
  #     DeploymentId: !Ref ApiGatewayDeployment
  #     Description: API Gateway Stage
  #     RestApiId: !Ref PprmrApiGateway
  #     StageName: !Sub "${Environment}"

  #API Gateway log
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/api-gateway/${GroupResourcePrefix}-${Environment}-${AppPrefix}-api"

  ApiGatewayDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - ApiGatewayGetBucketMethod
      - ApiGatewayGetPresignedUrlMethod
      - ApiGatewayS3BucketMethodOptions
    Properties:
      Description: API Deployment
      RestApiId: !Ref PprmrApiGateway
      StageName: !Sub "${Environment}"
      StageDescription:
        Description: Deployment Stage
        AccessLogSetting:
          DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
          Format: '{"apiId":"$context.apiId","stage":"$context.stage","resourcePath":"$context.resourcePath","requestId":"$context.requestId","awsEndpointRequestId":"$context.awsEndpointRequestId","xrayTraceId":"$context.xrayTraceId","requestTime":"$context.requestTime","requestTimeEpoch":$context.requestTimeEpoch,"httpMethod":"$context.httpMethod","status":"$context.status","path":"$context.path"}'
        LoggingLevel: INFO
        MetricsEnabled: true
        DataTraceEnabled: true
        TracingEnabled: true

  #Get Bucket Contents Endpoint
  ApiGatewayGetBucketMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      ApiKeyRequired: false
      AuthorizationType: NONE
      HttpMethod: GET
      Integration:
        ConnectionType: INTERNET
        Credentials: !GetAtt PprmrApiGatewayRole.Arn
        IntegrationHttpMethod: GET
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              { "method.response.header.Access-Control-Allow-Origin": "'*'" }
          - StatusCode: 400
            SelectionPattern: 4\d{2}
            ResponseParameters:
              { "method.response.header.Access-Control-Allow-Origin": "'*'" }
          - StatusCode: 500
            SelectionPattern: 5\d{2}
            ResponseParameters:
              { "method.response.header.Access-Control-Allow-Origin": "'*'" }
        PassthroughBehavior: WHEN_NO_MATCH
        RequestParameters:
          integration.request.path.bucket: method.request.path.bucket
        Type: AWS
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:s3:path/{bucket}"
      MethodResponses:
        - StatusCode: 200
          ResponseModels: { "application/xml": "Empty" }
          ResponseParameters:
            { "method.response.header.Access-Control-Allow-Origin": false }
        - StatusCode: 400
          ResponseParameters:
            { "method.response.header.Access-Control-Allow-Origin": false }
        - StatusCode: 500
          ResponseParameters:
            { "method.response.header.Access-Control-Allow-Origin": false }
      RequestParameters:
        method.request.path.bucket: false
      ResourceId: !Ref PprmrApiGatewayBucketResource
      RestApiId: !Ref PprmrApiGateway

  #Option Method S3 Bucket URL
  ApiGatewayS3BucketMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      ApiKeyRequired: false
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        ConnectionType: INTERNET
        IntegrationHttpMethod: OPTIONS
        PassthroughBehavior: WHEN_NO_MATCH
        Type: MOCK
        RequestTemplates: { "application/json": "" }
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              {
                "method.response.header.Access-Control-Allow-Origin": "'*'",
                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'",
                "method.response.header.Access-Control-Allow-Methods": "'GET,OPTIONS'",
              }
      MethodResponses:
        - StatusCode: 200
          ResponseModels: { "application/json": "Empty" }
          ResponseParameters:
            {
              "method.response.header.Access-Control-Allow-Origin": false,
              "method.response.header.Access-Control-Allow-Headers": false,
              "method.response.header.Access-Control-Allow-Methods": false,
            }
      RequestParameters:
        method.request.path.bucket: false
      ResourceId: !Ref PprmrApiGatewayBucketResource
      RestApiId: !Ref PprmrApiGateway

  #Get Presigned URL
  ApiGatewayGetPresignedUrlMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      ApiKeyRequired: false
      AuthorizationType: NONE
      HttpMethod: GET
      Integration:
        ConnectionType: INTERNET
        #Credentials: !GetAtt PprmrApiGatewayRole.Arn
        IntegrationHttpMethod: POST
        PassthroughBehavior: WHEN_NO_MATCH
        Type: AWS_PROXY
        RequestTemplates: { "application/json": "" }
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${PprmrPresgnUrlFunction.Arn}/invocations"
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ""
            StatusCode: 200
      MethodResponses:
        - StatusCode: 200
          ResponseModels: { "application/json": "Empty" }
          ResponseParameters:
            { "method.response.header.Access-Control-Allow-Origin": false }
        - StatusCode: 400
          ResponseParameters:
            { "method.response.header.Access-Control-Allow-Origin": false }
        - StatusCode: 500
          ResponseParameters:
            { "method.response.header.Access-Control-Allow-Origin": false }
      RequestParameters:
        method.request.path.bucket: false
        method.request.path.key: false
        method.request.querystring.method: false
      ResourceId: !Ref PprmrApiGatewayPresignedBucketKeyResource
      RestApiId: !Ref PprmrApiGateway

  #Option Method Presigned URL
  ApiGatewayGetPresignedUrlMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      ApiKeyRequired: false
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        ConnectionType: INTERNET
        IntegrationHttpMethod: OPTIONS
        PassthroughBehavior: WHEN_NO_MATCH
        Type: MOCK
        RequestTemplates: { "application/json": "" }
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              {
                "method.response.header.Access-Control-Allow-Origin": "'*'",
                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'",
                "method.response.header.Access-Control-Allow-Methods": "'GET,OPTIONS'",
              }
      MethodResponses:
        - StatusCode: 200
          ResponseModels: { "application/json": "Empty" }
          ResponseParameters:
            {
              "method.response.header.Access-Control-Allow-Origin": false,
              "method.response.header.Access-Control-Allow-Headers": false,
              "method.response.header.Access-Control-Allow-Methods": false,
            }
      RequestParameters:
        method.request.path.bucket: false
        method.request.path.key: false
      ResourceId: !Ref PprmrApiGatewayPresignedBucketKeyResource
      RestApiId: !Ref PprmrApiGateway

  #Certificate
  APICustomDomain:
    Type: AWS::ApiGateway::DomainName
    # DependsOn: APICustomCertificate
    Properties:
      DomainName: !Ref APICustomUri
      EndpointConfiguration:
        Types:
          - !Ref APIEndpointType
      RegionalCertificateArn: !Ref APICustomCertificate
      SecurityPolicy: TLS_1_2
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  APICustomDomainMapping:
    Type: AWS::ApiGateway::BasePathMapping
    # DependsOn: APICustomDomain
    Properties:
      # BasePath: !Ref APIStageID
      DomainName: !Ref APICustomDomain
      RestApiId: !Ref PprmrApiGateway
      Stage: !Sub "${Environment}"

  APICustomCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      CertificateAuthorityArn: !Ref CertificateAuthorityArnValue
      CertificateTransparencyLoggingPreference: DISABLED
      DomainName: !Ref APICustomUri
      Tags:
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: uniqueID
          Value: !Ref UniqueID
        - Key: dataClassification
          Value: !Ref DataClassification
        - Key: supportGroup
          Value: !Ref SupportGroup
        - Key: changeGroup
          Value: !Ref ChangeGroup
        - Key: blockcode
          Value: !Ref Blockcode
        - Key: drTier
          Value: !Ref DrTier
        - Key: pciIndicator
          Value: !Ref PciIndicator
        - Key: phiIndicator
          Value: !Ref PhiIndicator
        - Key: soxIndicator
          Value: !Ref SoxIndicator
        - Key: cuiIndicator
          Value: !Ref CuiIndicator

  # APICustomRoute53:
  #   Type: AWS::Route53::RecordSet
  #   Properties:
  #     HostedZoneName: !Ref Route53HostedZone
  #     Name: !Ref APICustomUri
  #     Type: A
  #     ResourceRecords:
  #       - !Ref APICustomDomain
  #     TTL: 300

  APICustomRoute53:
    Type: AWS::Route53::RecordSetGroup
    DependsOn: APICustomDomain
    Properties:
      HostedZoneName: !Ref Route53HostedZone
      RecordSets:
        - Name: !Ref APICustomUri
          Type: A
          AliasTarget:
            DNSName: !GetAtt APICustomDomain.RegionalDomainName
            HostedZoneId: !GetAtt APICustomDomain.RegionalHostedZoneId

#create certificate
#create domain name
#create Route 53 entry

Outputs:
  UploadedFilesS3Bucket:
    Description: S3 Bucket for uploaded PDF files
    Value: !Sub "${UploadFilesBucketName}"

  ConvertedFilesS3Bucket:
    Description: S3 Bucket for converted PDF files
    Value: !Sub "${S3LogsBucketName}"

  S3LogsS3Bucket:
    Description: S3 Bucket for S3 Logs
    Value: !Sub "${ConvertedFilesBucketName}"

  PdfPwRemoverLambdaFunc:
    Description: PDF Pw Remover Lambda Function that removes pw permission from PDF
    Value: !GetAtt PprmrLambdaFunction.Arn

  PdfPwRemoverPresignUrlLambdaFunc:
    Description: PDF Pw Remover Lambda Function that returns S3 Presigned URL
    Value: !GetAtt PprmrPresgnUrlFunction.Arn

  PdfPwRemoverApiGateway:
    Description: PDF Pw Remover API Gateway
    Value: !Ref PprmrApiGateway

  PdfPwRemoveDomainName:
    Description: PDF Pw Remover Route 53
    Value: !Ref APICustomUri
